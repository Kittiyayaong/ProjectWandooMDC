# Module 5 - Agentless container vulnerability assessment scanning

## 목표
이 Module은 Microsoft Defender 취약성 관리를 기반으로 하는 에이전트 없는 컨테이너 이미지 취약성 평가 스캔을 Azure 컨테이너 레지스트리에 대해 검증하고 사용하는 방법을 안내합니다.

### 전제 조건
이 기능을 사용하려면 구독에서 Defender for Containers 또는 Defender Cloud 보안 자세 관리 기능을 활성화해야 합니다. 

MDC console > Management > Envorionment settings > 하단에 테스트 대상 Subscription 이동 > Defender Plans > 상단에 Settings & monitoring > Agentless scanning for machines가 **on**으로 설정되어있는지 확인 
![image](https://github.com/user-attachments/assets/5bca1492-0dbf-4b7f-b708-6fd6c7575d68)

### Lab 1: Install Docker Desktop
먼저, 기존 Azure 컨테이너 레지스트리에 취약한 이미지를 표시할 수 있도록 Docker Desktop을 설치해야 합니다.

1.	[Docker](https://www.docker.com/products/docker-desktop)로 이동하여 다운로드 후 install합니다. 
2.  Install 후, Powershell에서 Docker versoin을 확인합니다.
```
    docker version​
```
![image](https://github.com/user-attachments/assets/b5c03694-b619-4b8d-9296-715dbbacd972)


### Lab 2: Docker Hub에서 컨테이너 레지스트리로 취약 이미지 다운로드

이제 Docker를 사용하여 취약한 이미지를 다운로드하고, 이를 Lab 1의 ARM 템플릿을 사용하여 생성한 컨테이너 레지스트리로 푸시할 것입니다.

1. Azure 포털 > Container registries > 생성한 container 클릭 > Login Server 이름을 복사합니다. 
2. PowerShell을 열고 (여기서 NameOfServer는 위에서 복사한 것입니다) 아래 명령을 실행합니다: <br />

azure 계정에 로그인합니다. 
```
az login
```
```
az acr login --name NameOfServer
```
![image](https://github.com/user-attachments/assets/f75cf333-e51f-4d6e-8f60-37ef629219e1)

> ⭐ Tips: <br>
> 아직 Azure CLI를 설치하지 않은 경우 https://docs.microsoft.com/en-us/cli/azure/install-azure-cli 를 방문하여 지침을 확인하세요. 또한 위의 명령을 실행하기 전에 *az 로그인*을 통해 Azure 구독에 로그인해야 합니다.

3. 도커 허브에서 취약한 이미지를 다운로드하세요(자세한 내용은 https://hub.docker.com/r/vulnerables/web-dvwa/ 에서 확인할 수 있습니다)

Powershell에서 아래 명령을 실행합니다:
```
docker pull vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/3e5808a2-8df5-47b9-baa3-d5dc6e9d0f4a)

4. 아래 명령을 실행하여 로컬 저장소의 이미지를 확인합니다:
```
docker images vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/9a810a4e-0a48-4634-88a2-fa5b2dfe694c)

5. 다음 명령어를 실행하여 이미지의 별칭을 만듭니다(위에서 복사한 서버 이름을 사용합니다.)
```
docker tag vulnerables/web-dvwa <서버명>.azurecr.io/vulnerables/web-dvwa
```

6. 아래 명령을 실행하여 로컬 저장소의 이미지를 다시 확인하세요: 
```
docker images ,서버명>.azurecr.io/vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/55dd54fa-2bef-43bd-8f91-d9468920ea7f)

7. 도커 푸시를 실행하여 새 이미지를 azure 저장소에 업로드하고 아래 명령을 사용하여 이미지 스캔을 생성합니다(시간이 좀 걸릴 수 있습니다)<br />
```
docker push ,서버명>.azurecr.io/vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/8412d3c5-d97f-4c17-8f9f-93d8dbb4d8af)


8. 그런 다음 Azure 포털로 이동하여 생성한 컨테이너 레지스트리를 찾아보세요.
9. 컨테이너 레지스트리의 리포지토리로 이동합니다. ACR 리포지토리에서 취약한 이미지가 발견되었습니다.


