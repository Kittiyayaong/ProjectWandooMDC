# Module 1 - Agentless container vulnerability assessment scanning

## 목표
이 Module은 Microsoft Defender 취약성 관리를 기반으로 하는 에이전트 없는 컨테이너 이미지 취약성 평가 스캔을 Azure 컨테이너 레지스트리에 대해 검증하고 사용하는 방법을 안내합니다.

### 전제 조건
이 기능을 사용하려면 구독에서 Defender for Containers 또는 Defender Cloud 보안 자세 관리 기능을 활성화해야 합니다. 

MDC console > Management > Envorionment settings > 하단에 테스트 대상 Subscription 이동 > Defender Plans > 상단에 Settings & monitoring > Agentless scanning for machines가 **on**으로 설정되어있는지 확인 
![image](https://github.com/user-attachments/assets/5bca1492-0dbf-4b7f-b708-6fd6c7575d68)

### Lab 1: Install Docker Desktop
먼저, 기존 Azure 컨테이너 레지스트리에 취약한 이미지를 표시할 수 있도록 Docker Desktop을 설치해야 합니다.

1.	[Docker](https://www.docker.com/products/docker-desktop)로 이동하여 다운로드 후 install합니다. Windows는 2번, Mac은 3번으로 이동해서 진행합니다. 
2. Windows OS
2-1. Install 후, Powershell에서 Docker versoin을 확인합니다.
```
    docker version​
```
![image](https://github.com/user-attachments/assets/b5c03694-b619-4b8d-9296-715dbbacd972)

3. Mac OS
3-1. 설치 완료 후, 터미널에서 Docker 실행 확인

    ```bash
   docker version

<img width="682" alt="image" src="https://github.com/user-attachments/assets/72d354e0-1aa5-49c8-9c2a-358c7b7f9a28" />

---

### Lab 2: Windows - Docker Hub에서 컨테이너 레지스트리로 취약 이미지 다운로드

이제 Docker를 사용하여 취약한 이미지를 다운로드하고, 이를 Lab 1의 ARM 템플릿을 사용하여 생성한 컨테이너 레지스트리로 푸시할 것입니다.

1. Azure 포털 > Container registries > 생성한 container 클릭 > Login Server 이름을 복사합니다. 
2. PowerShell을 열고 (여기서 NameOfServer는 위에서 복사한 것입니다) 아래 명령을 실행합니다: <br />

azure 계정에 로그인합니다. 
```
az login
```
```
az acr login --name NameOfServer
```
![image](https://github.com/user-attachments/assets/f75cf333-e51f-4d6e-8f60-37ef629219e1)

> ⭐ Tips: <br>
> 아직 Azure CLI를 설치하지 않은 경우 https://docs.microsoft.com/en-us/cli/azure/install-azure-cli 를 방문하여 지침을 확인하세요. 또한 위의 명령을 실행하기 전에 *az 로그인*을 통해 Azure 구독에 로그인해야 합니다.

3. 도커 허브에서 취약한 이미지를 다운로드하세요(자세한 내용은 https://hub.docker.com/r/vulnerables/web-dvwa/ 에서 확인할 수 있습니다)

Powershell에서 아래 명령을 실행합니다:
```
docker pull vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/3e5808a2-8df5-47b9-baa3-d5dc6e9d0f4a)

4. 아래 명령을 실행하여 로컬 저장소의 이미지를 확인합니다:
```
docker images vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/9a810a4e-0a48-4634-88a2-fa5b2dfe694c)

5. 다음 명령어를 실행하여 이미지의 별칭을 만듭니다(위에서 복사한 서버 이름을 사용합니다.)
```
docker tag vulnerables/web-dvwa <서버명>.azurecr.io/vulnerables/web-dvwa
```

6. 아래 명령을 실행하여 로컬 저장소의 이미지를 다시 확인하세요: 
```
docker images ,서버명>.azurecr.io/vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/55dd54fa-2bef-43bd-8f91-d9468920ea7f)

7. 도커 푸시를 실행하여 새 이미지를 azure 저장소에 업로드하고 아래 명령을 사용하여 이미지 스캔을 생성합니다(시간이 좀 걸릴 수 있습니다)<br />
```
docker push ,서버명>.azurecr.io/vulnerables/web-dvwa
```
![image](https://github.com/user-attachments/assets/8412d3c5-d97f-4c17-8f9f-93d8dbb4d8af)


8. azure portal > container registires > WandooContainer > Repositories에서 내용을 확인할 수 있습니다. 
![image](https://github.com/user-attachments/assets/78f2aaac-c9c1-4bc0-b058-50e17f3a7eb6)

> ⭐ Tips: <br>
> **Damn Vulnerable Web Application (DVWA)**는 보안 전문가들이 자신의 기술과 도구를 합법적인 환경에서 테스트할 수 있도록 돕기 위해 설계된 PHP/MariaDB 웹 애플리케이션입니다. DVWA는 다양한 난이도의 일반적인 웹 취약점을 연습할 수 있는 간단하고 직관적인 인터페이스를 제공합니다. 이 소프트웨어에는 의도적으로 문서화된 취약점과 문서화되지 않은 취약점이 모두 포함되어 있으며, 사용자는 가능한 많은 문제를 발견하고 해결하는 것을 권장합니다

---

### Lab 3: Mac - Docker Hub에서 컨테이너 레지스트리로 취약 이미지 다운로드

✅ Azure CLI 설치 (이미 설치된 경우는 2번으로 넘어갑니다.)

#### 1. homebrew

1-1. homebrew 설치 확인

```bash
brew --version
```

1-2. 설치되지 않았을 경우? 

```bash
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
```

1-3. homebrew 업데이트
```bash
brew update
```

<img width="682" alt="image" src="https://github.com/user-attachments/assets/f28f80f5-f953-4fbf-b41a-495242e616b3" />

#### 2. azure cli

2-1. 설치
```bash
brew install azure-cli
```

2-2. Azure CLI 설치 확인
```bash
az --version
```

<img width="682" alt="image" src="https://github.com/user-attachments/assets/04dbea37-e205-4edd-ad61-49c9c0c65b88" />

2-2. Azure CLI 로그인: 브라우저가 열리면 Azure 계정으로 로그인
```bash
az login
```

#### 3. Azure Container Registry

3-1. 로그인
```bash
az acr login --name <YourContainerRegistryName>
```
> 예시
> ```bash
> az acr login --name wandootestcontainer
> ```

#### Docker
4-1. Docker 설치 여부 확인
```bash
docker --version
```

#### 5. Docker Hub에서 취약 이미지 다운로드 후 ACR에 업로드

5-1. 취약 이미지 다운로드
```bash
docker pull vulnerables/web-dvwa
```

5-2. 로컬 이미지 확인
```bash
docker images vulnerables/web-dvwa
```

5-3. 이미지 태그 변경 (ACR용)
```bash
docker tag vulnerables/web-dvwa <YourContainerRegistryName>.azurecr.io/vulnerables/web-dvwa
```

5-4. 태그 변경된 이미지 확인
```bash
docker images <YourContainerRegistryName>.azurecr.io/vulnerables/web-dvwa
```

5-5. 이미지 ACR로 푸시
```bash
docker push <YourContainerRegistryName>.azurecr.io/vulnerables/web-dvwa
```

#### 6. Azure Portal에서 업로드 확인

Azure Portal ➔ Container Registries ➔ 본인 레지스트리 ➔ Service ➔ Repositories ➔ vulnerables/web-dvwa 이미지 존재 확인

<img width="1429" alt="스크린샷 2025-07-06 오후 1 59 33" src="https://github.com/user-attachments/assets/389f1236-1a37-425d-924a-06b044096278" />

> ⭐️ Tips. DVWA란? (Damn Vulnerable Web Application (DVWA))
>
> * 의도적으로 취약한 PHP/MariaDB 웹앱
> * 보안 훈련 및 모의 해킹 연습용
> * [DVWA Docker Hub](https://hub.docker.com/r/vulnerables/web-dvwa/)

---

### Lab 4: ACR의 취약점에 대한 권장 사항 조사
취약한 이미지가 Azure 컨테이너 레지스트리로 푸시되면 Microsoft Defender for Cloud는 Microsoft Defender 취약성 관리를 사용하여 이미지에 취약성이 있는지 스캔하기 시작합니다. 이제 Microsoft Defender for Cloud의 권장 사항을 살펴보겠습니다.

1. MDC > recommendations > Resource type 필터를 **Container Image**로 설정합니다
![image](https://github.com/user-attachments/assets/b6a17f11-bb99-4bd2-ae8b-8357fd9fa9db)

2.  **Container images in Azure registry should have vulnerability findings resolved** 라는 recommendation을 찾아서 릭하면 자세한 내용을 확인할 수 있습니다. Attected resource는 web-dvwa인 항목으로 확인합니다. 
3.  권장 사항에 있는 내용을 둘러보세요. 수정 단계와 소견 탭을 확인하세요. 소견 탭을 클릭하여 감지된 모든 CVE를 확인하세요.

    ![image](https://github.com/user-attachments/assets/8b4086c1-8d90-4ff6-ac0d-76b409423d19)
